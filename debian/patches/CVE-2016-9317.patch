From 6944ea10cb730d5071620439c6c2e823e6caeff1 Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Sat, 12 Nov 2016 15:00:31 +0100
Subject: [PATCH] Fix #340: System frozen

gdImageCreate() doesn't check for oversized images and as such is prone
to DoS vulnerabilities. We fix that by applying the same overflow check
that is already in place for gdImageCreateTrueColor().

CVE-2016-9317

Conflicts:
	src/gd.c
---
 src/gd.c                           |  4 ++++
 tests/CMakeLists.txt               |  1 +
 tests/Makefile.am                  |  1 +
 tests/gdimagecreate/.gitignore     |  1 +
 tests/gdimagecreate/CMakeLists.txt |  5 +++++
 tests/gdimagecreate/Makemodule.am  |  5 +++++
 tests/gdimagecreate/bug00340.c     | 33 +++++++++++++++++++++++++++++++++
 7 files changed, 50 insertions(+)
 create mode 100644 tests/gdimagecreate/.gitignore
 create mode 100644 tests/gdimagecreate/CMakeLists.txt
 create mode 100644 tests/gdimagecreate/Makemodule.am
 create mode 100644 tests/gdimagecreate/bug00340.c

Index: libgd2-2.2.1/src/gd.c
===================================================================
--- libgd2-2.2.1.orig/src/gd.c	2017-02-28 09:46:15.274992524 -0500
+++ libgd2-2.2.1/src/gd.c	2017-02-28 09:46:15.270992476 -0500
@@ -163,6 +163,10 @@
 	int i;
 	gdImagePtr im;
 
+	if (overflow2(sx, sy)) {
+		return NULL;
+	}
+
 	if (overflow2(sizeof (unsigned char *), sy)) {
 		return NULL;
 	}
