From 69d2fd2c597ffc0c217de1238b9bf4d4bceba8e6 Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Sat, 17 Dec 2016 17:06:58 +0100
Subject: [PATCH] Fix #354: Signed Integer Overflow gd_io.c

GD2 stores the number of horizontal and vertical chunks as words (i.e. 2
byte unsigned). These values are multiplied and assigned to an int when
reading the image, what can cause integer overflows. We have to avoid
that, and also make sure that either chunk count is actually greater
than zero. If illegal chunk counts are detected, we bail out from
reading the image.
---
 src/gd_gd2.c             |   4 ++++
 tests/gd2/.gitignore     |   1 +
 tests/gd2/CMakeLists.txt |   1 +
 tests/gd2/Makemodule.am  |   3 +++
 tests/gd2/bug00354.c     |  32 ++++++++++++++++++++++++++++++++
 tests/gd2/bug00354a.gd2  | Bin 0 -> 92 bytes
 tests/gd2/bug00354b.gd2  | Bin 0 -> 18 bytes
 7 files changed, 41 insertions(+)
 create mode 100644 tests/gd2/bug00354.c
 create mode 100644 tests/gd2/bug00354a.gd2
 create mode 100644 tests/gd2/bug00354b.gd2

Index: libgd2-2.1.1/src/gd_gd2.c
===================================================================
--- libgd2-2.1.1.orig/src/gd_gd2.c	2017-02-28 10:29:28.741672472 -0500
+++ libgd2-2.1.1/src/gd_gd2.c	2017-02-28 10:29:28.741672472 -0500
@@ -153,6 +153,10 @@
 	GD2_DBG (printf ("%d Chunks vertically\n", *ncy));
 
 	if (gd2_compressed (*fmt)) {
+		if (*ncx <= 0 || *ncy <= 0 || *ncx > INT_MAX / *ncy) {
+			GD2_DBG(printf ("Illegal chunk counts: %d * %d\n", *ncx, *ncy));
+			goto fail1;
+		}
 		nc = (*ncx) * (*ncy);
 
 		GD2_DBG (printf ("Reading %d chunk index entries\n", nc));
