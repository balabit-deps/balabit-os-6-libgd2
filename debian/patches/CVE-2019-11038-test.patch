Description: test for CVE-2019-11038
 Cherry-picked from upstream commits, a test of the CVE-2019-11038 fix
Author: Lance Wang <lzwang@suse.com>
Author: Christoph M. Becker <cmbecker69@gmx.de>
Origin: upstream,
 https://github.com/wang0z/libgd/commit/c716ea9971f02979352f1b0ccb4e7a05e372c5fd
Last-Update: 2020-03-09
--- /dev/null
+++ b/tests/xbm/CMakeLists.txt
@@ -0,0 +1 @@
+LIST(APPEND TESTS_FILES github_bug_501)
--- /dev/null
+++ b/tests/xbm/github_bug_501.c
@@ -0,0 +1,48 @@
+/*
+   Test reading an invalid XBM image.
+
+   The pixels of the XBM image are invalid hex which makes the uninitialezed
+   variable be encoded into the output image i.e. information disclosure.
+   The image is 8*2.
+
+   See also <https://github.com/libgd/libgd/issues/501>.
+*/
+
+#include "gd.h"
+#include "gdtest.h"
+#ifdef _WIN32
+
+int main()
+{
+   /* skip for now */
+   return 0;
+}
+#else
+
+int main()
+{
+
+   gdImagePtr im;
+   FILE *fp;
+
+   fp = gdTestFileOpen2("xbm", "github_bug_501.xbm");
+   im = gdImageCreateFromXbm(fp);
+
+   gdTestAssert(im == NULL);
+
+   if (im) {
+       gdTestErrorMsg("Info Disclosed\n");
+       int i;
+       for (i = 0; i < 8; i++) {
+           printf("Pixel(%d, 0) %0x\n", i, gdImageGetPixel(im, i, 0));
+       }
+       for (i = 0; i < 8; i++) {
+           printf("Pixel(%d, 1) %0x\n", i, gdImageGetPixel(im, i, 1));
+       }
+       gdImageDestroy(im);
+   }
+
+   fclose(fp);
+   return gdNumFailures();
+}
+#endif
--- /dev/null
+++ b/tests/xbm/github_bug_501.xbm
@@ -0,0 +1,4 @@
+#define width 8
+#define height 2
+static char bits[] ={
+xzzxzz
--- a/tests/CMakeLists.txt
+++ b/tests/CMakeLists.txt
@@ -50,6 +50,7 @@ if (BUILD_TEST)
 		gdtiled
 		gif
 		tga
+		xbm
 		wbmp
 	)
 
--- a/tests/Makefile.am
+++ b/tests/Makefile.am
@@ -23,6 +23,7 @@ check_PROGRAMS = \
 	gdimagefilledrectangle/bug00004 \
 	gdimagefilledrectangle/bug00106_gdimagefilledrectangle \
 	gdimagecolordeallocate/gdimagecolordeallocate \
+	xbm/github_bug_501 \
 	wbmp/wbmp_null \
 	gdimagecolortransparent/gdimagecolortransparent \
 	gif/bug00005_2 \
@@ -224,6 +225,7 @@ EXTRA_DIST = \
 	xpm/bug00185.xpm \
 	xpm/bug00185_damaged.xpm \
 	xpm/color_name.xpm \
+	xbm/github_bug_501.xbm \
 	gdtiled/bug00032_exp.png \
 	jpeg/conv_test.jpeg \
 	jpeg/conv_test_exp.png \
@@ -289,6 +291,7 @@ EXTRA_DIST = \
 	gdimagestringft/CMakeLists.txt \
 	gdtest/CMakeLists.txt \
 	xpm/CMakeLists.txt \
+	xbm/CMakeLists.txt \
 	gdtiled/CMakeLists.txt \
 	jpeg/CMakeLists.txt \
 	gd2/CMakeLists.txt \
