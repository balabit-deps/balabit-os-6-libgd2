From fe9ed49dafa993e3af96b6a5a589efeea9bfb36f Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Tue, 16 Aug 2016 18:23:36 +0200
Subject: [PATCH] Fix DOS vulnerability in gdImageCreateFromGd2Ctx()

We must not pretend that there are image data if there are none. Instead
we fail reading the image file gracefully.
---
 src/gd_gd2.c                     |  14 ++++++--------
 tests/gd2/.gitignore             |   1 +
 tests/gd2/CMakeLists.txt         |   1 +
 tests/gd2/Makemodule.am          |   7 +++++--
 tests/gd2/too_few_image_data.c   |  22 ++++++++++++++++++++++
 tests/gd2/too_few_image_data.gd2 | Bin 0 -> 1050 bytes
 6 files changed, 35 insertions(+), 10 deletions(-)
 create mode 100644 tests/gd2/too_few_image_data.c
 create mode 100644 tests/gd2/too_few_image_data.gd2

Index: libgd2-2.1.1/src/gd_gd2.c
===================================================================
--- libgd2-2.1.1.orig/src/gd_gd2.c	2017-02-28 10:29:22.221595342 -0500
+++ libgd2-2.1.1/src/gd_gd2.c	2017-02-28 10:29:22.221595342 -0500
@@ -448,18 +448,16 @@
 
 						if (im->trueColor) {
 							if (!gdGetInt (&im->tpixels[y][x], in)) {
-								/*printf("EOF while reading\n"); */
-								/*gdImageDestroy(im); */
-								/*return 0; */
-								im->tpixels[y][x] = 0;
+								gd_error("gd2: EOF while reading\n");
+								gdImageDestroy(im);
+								return NULL;
 							}
 						} else {
 							int ch;
 							if (!gdGetByte (&ch, in)) {
-								/*printf("EOF while reading\n"); */
-								/*gdImageDestroy(im); */
-								/*return 0; */
-								ch = 0;
+								gd_error("gd2: EOF while reading\n");
+								gdImageDestroy(im);
+								return NULL;
 							}
 							im->pixels[y][x] = ch;
 						}
