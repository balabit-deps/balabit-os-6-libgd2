From 77f619d48259383628c3ec4654b1ad578e9eb40e Mon Sep 17 00:00:00 2001
From: Pierre Joye <pierre.php@gmail.com>
Date: Sat, 4 Jun 2016 23:09:01 +0700
Subject: [PATCH] fix #215 gdImageFillToBorder stack-overflow when invalid
 color is used

---
 src/gd.c                                 | 8 +++++++-
 tests/gdimagefilltoborder/.gitignore     | 1 +
 tests/gdimagefilltoborder/CMakeLists.txt | 1 +
 tests/gdimagefilltoborder/Makemodule.am  | 3 ++-
 4 files changed, 11 insertions(+), 2 deletions(-)

Index: libgd2-2.1.1/src/gd.c
===================================================================
--- libgd2-2.1.1.orig/src/gd.c	2017-02-28 10:29:06.365407768 -0500
+++ libgd2-2.1.1/src/gd.c	2017-02-28 10:29:06.361407720 -0500
@@ -1935,11 +1935,17 @@
 	int i;
 	int restoreAlphaBleding;
 
-	if (border < 0) {
+	if (border < 0 || color < 0) {
 		/* Refuse to fill to a non-solid border */
 		return;
 	}
 
+	if (!im->trueColor) {
+		if ((color > (im->colorsTotal - 1)) || (border > (im->colorsTotal - 1))) {
+			return;
+		}
+    }
+
 	leftLimit = (-1);
 
 	restoreAlphaBleding = im->alphaBlendingFlag;
